<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat with <%= otherUser.fullname %></title>
  <link rel="stylesheet" href="/stylesheets/chat.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
      <h3><%= otherUser.fullname %></h3>
    </div>

    <!-- Messages -->
    <div id="messages" class="chat-messages">
      <% messages.forEach(msg => { %>
        <div class="message <%= msg.sender.equals(currentUser._id) ? 'sent' : 'received' %>">
          <p><%= msg.text %></p>
          <small>
            <%= msg.createdAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
          </small>
        </div>
      <% }) %>
    </div>

    <!-- Input -->
    <form id="chatForm" class="chat-form">
      <input id="msg" type="text" placeholder="Type a message..." autocomplete="off" required />
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
  const socket = io();

  const form = document.getElementById("chatForm");
  const input = document.getElementById("msg");
  const messages = document.getElementById("messages");

  const currentUserId = "<%= currentUser._id %>";
  const otherUserId = "<%= otherUser._id %>";

  // ðŸ‘‰ Join the private room for this conversation
  socket.emit("joinChat", { senderId: currentUserId, receiverId: otherUserId });

  // Send message
  form.addEventListener("submit", function(e) {
    e.preventDefault();
    if (input.value.trim() !== "") {
      socket.emit("chatMessage", {
        senderId: currentUserId,
        receiverId: otherUserId,
        text: input.value
      });
      input.value = "";
    }
  });

  // Receive message
  socket.on("chatMessage", function(msg) {
    const div = document.createElement("div");
    div.classList.add("message");
    div.classList.add(msg.senderId === currentUserId ? "sent" : "received");
    div.innerHTML = `<p>${msg.text}</p>`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  });
</script>

</body>
</html>
