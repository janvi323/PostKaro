<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with <%= otherUser.fullname || otherUser.username %></title>
  <link rel="stylesheet" href="/stylesheets/chat.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="chat-container">
    <!-- Instagram-Style Chat Header -->
    <div class="chat-header">
      <a href="/conversations" class="back-btn">
        <i class="fas fa-arrow-left"></i>
      </a>
      
      <div class="header-user-info">
        <img src="<%= otherUser.dp || '/images/default-avatar.svg' %>" 
             alt="<%= otherUser.username %>" 
             class="header-avatar">
        
        <div class="header-user-details">
          <h3><%= otherUser.fullname || otherUser.username %></h3>
          <p>@<%= otherUser.username %></p>
        </div>
      </div>
      
      <div class="header-actions">
        <button class="header-action-btn" title="Video call">
          <i class="fas fa-video"></i>
        </button>
        <button class="header-action-btn" title="Voice call">
          <i class="fas fa-phone"></i>
        </button>
        <button class="header-action-btn" title="More options">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      </div>
    </div>

    <!-- Messages Container -->
    <div class="chat-messages" id="messagesContainer">
      <% if (messages && messages.length > 0) { %>
        <% messages.forEach(function(message) { %>
          <div class="message <%= message.sender._id.toString() === currentUser._id.toString() ? 'sent' : 'received' %>">
            <% if (message.sender._id.toString() !== currentUser._id.toString()) { %>
              <img src="<%= message.sender.dp || '/images/default-avatar.svg' %>" 
                   alt="<%= message.sender.username %>" 
                   class="message-avatar">
            <% } %>
            
            <div class="message-content">
              <div class="message-bubble">
                <%= message.text %>
              </div>
              <div class="message-time">
                <%= new Date(message.createdAt).toLocaleTimeString('en-US', { 
                  hour: 'numeric', 
                  minute: '2-digit',
                  hour12: true 
                }) %>
              </div>
            </div>
            
            <% if (message.sender._id.toString() === currentUser._id.toString()) { %>
              <img src="<%= currentUser.dp || '/images/default-avatar.svg' %>" 
                   alt="<%= currentUser.username %>" 
                   class="message-avatar">
            <% } %>
          </div>
        <% }); %>
      <% } else { %>
        <div class="empty-chat">
          <i class="fas fa-comments"></i>
          <h3>Start your conversation</h3>
          <p>Send a message to <%= otherUser.fullname || otherUser.username %> to begin chatting</p>
        </div>
      <% } %>
    </div>

    <!-- Message Input - Instagram Style -->
    <div class="chat-input-container">
      <form class="message-form" action="/chat/<%= otherUser._id %>/send" method="POST">
        <button type="button" class="attachment-btn" title="Attach file">
          <i class="fas fa-plus"></i>
        </button>
        
        <input type="text" 
               name="text" 
               class="message-input" 
               placeholder="Message <%= otherUser.fullname || otherUser.username %>..." 
               autocomplete="off"
               required>
        
        <button type="submit" class="send-btn" title="Send message">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </div>

  <style>
    .header-actions {
      display: flex;
      gap: 8px;
    }
    
    .header-action-btn {
      width: 36px;
      height: 36px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--pinterest-white);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .header-action-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }
    
    .attachment-btn {
      width: 36px;
      height: 36px;
      background: var(--pinterest-light-grey);
      border: none;
      color: var(--pinterest-grey);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .attachment-btn:hover {
      background: var(--pinterest-red);
      color: var(--pinterest-white);
      transform: scale(1.05);
    }
    
    .typing-indicator {
      display: none;
      padding: 12px 16px;
      color: var(--pinterest-grey);
      font-style: italic;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    
    .online-status {
      width: 12px;
      height: 12px;
      background: #4CAF50;
      border: 2px solid var(--pinterest-white);
      border-radius: 50%;
      position: absolute;
      bottom: 2px;
      right: 2px;
    }
    
    .header-user-info {
      position: relative;
    }
    
    .header-avatar {
      position: relative;
    }
  </style>

  <script>
    const socket = io();
    const messagesContainer = document.getElementById('messagesContainer');
    const messageForm = document.querySelector('.message-form');
    const messageInput = document.querySelector('.message-input');
    
    const currentUserId = '<%= currentUser._id %>';
    const otherUserId = '<%= otherUser._id %>';
    
    // Join the chat room
    socket.emit('join-chat', {
      currentUserId: currentUserId,
      otherUserId: otherUserId
    });
    
    // Listen for new messages
    socket.on('new-message', function(data) {
      if ((data.sender === otherUserId && data.receiver === currentUserId) ||
          (data.sender === currentUserId && data.receiver === otherUserId)) {
        addMessageToChat(data);
        scrollToBottom();
      }
    });
    
    // Add message to chat UI
    function addMessageToChat(messageData) {
      const messageDiv = document.createElement('div');
      const isSent = messageData.sender === currentUserId;
      
      messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
      
      const avatarSrc = isSent ? 
        ('<%= currentUser.dp || "/images/default-avatar.svg" %>') : 
        ('<%= otherUser.dp || "/images/default-avatar.svg" %>');
      
      const username = isSent ? 
        ('<%= currentUser.username %>') : 
        ('<%= otherUser.username %>');
      
      messageDiv.innerHTML = `
        ${!isSent ? `<img src="${avatarSrc}" alt="${username}" class="message-avatar">` : ''}
        <div class="message-content">
          <div class="message-bubble">
            ${messageData.text}
          </div>
          <div class="message-time">
            ${new Date().toLocaleTimeString('en-US', { 
              hour: 'numeric', 
              minute: '2-digit',
              hour12: true 
            })}
          </div>
        </div>
        ${isSent ? `<img src="${avatarSrc}" alt="${username}" class="message-avatar">` : ''}
      `;
      
      messagesContainer.appendChild(messageDiv);
    }
    
    // Auto-scroll to bottom
    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Handle form submission
    messageForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const messageText = messageInput.value.trim();
      
      if (messageText) {
        // Emit message via socket for real-time delivery
        socket.emit('send-message', {
          sender: currentUserId,
          receiver: otherUserId,
          text: messageText
        });
        
        // Clear input
        messageInput.value = '';
        
        // Also submit the form for persistence
        fetch(`/chat/${otherUserId}/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `text=${encodeURIComponent(messageText)}`
        }).catch(err => console.error('Error saving message:', err));
      }
    });
    
    // Handle Enter key
    messageInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        messageForm.dispatchEvent(new Event('submit'));
      }
    });
    
    // Focus input on load
    document.addEventListener('DOMContentLoaded', function() {
      messageInput.focus();
      scrollToBottom();
      
      // Add online status (simulated)
      const headerAvatar = document.querySelector('.header-avatar');
      if (headerAvatar) {
        const onlineStatus = document.createElement('div');
        onlineStatus.className = 'online-status';
        headerAvatar.parentElement.appendChild(onlineStatus);
      }
    });
    
    // Typing indicator
    let typingTimer;
    messageInput.addEventListener('input', function() {
      socket.emit('typing-start', { userId: currentUserId, chatWith: otherUserId });
      
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        socket.emit('typing-stop', { userId: currentUserId, chatWith: otherUserId });
      }, 1000);
    });
    
    socket.on('user-typing', function(data) {
      if (data.userId === otherUserId) {
        showTypingIndicator();
      }
    });
    
    socket.on('user-stopped-typing', function(data) {
      if (data.userId === otherUserId) {
        hideTypingIndicator();
      }
    });
    
    function showTypingIndicator() {
      let indicator = document.querySelector('.typing-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.innerHTML = '<%= otherUser.fullname || otherUser.username %> is typing...';
        messagesContainer.appendChild(indicator);
      }
      indicator.style.display = 'block';
      scrollToBottom();
    }
    
    function hideTypingIndicator() {
      const indicator = document.querySelector('.typing-indicator');
      if (indicator) {
        indicator.style.display = 'none';
      }
    }
  </script>
</body>
</html>