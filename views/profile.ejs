<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= user.fullname %> - Profile</title>
  <link rel="stylesheet" href="/stylesheets/profile.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <!-- âœ… Navbar -->
  <nav class="navbar">
    <!-- Logo -->
    <div class="navbar-logo">
      <a href="/"><i class="fab fa-pinterest"></i> PostKaro</a>
    </div>
   
    <!-- Types -->
    <ul class="navbar-types">
      <li><a href="/" class="active">Home</a></li>
      <li><a href="/explore">Explore</a></li>
      <li><a href="/today">Today</a></li>
    </ul>

    <!-- Search -->
    <div class="navbar-search">
      <input type="text" id="searchInput" placeholder="Search people..." autocomplete="off" />
      <div id="searchResults" class="search-results"></div>
    </div>

    <!-- Actions -->
    <ul class="navbar-actions">
      <li class="navbar-icon-container">
        <a href="/notifications">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notificationBadge">3+</span>
        </a>
      </li>
      <li class="navbar-icon-container">
        <a href="/profile">
          <i class="fas fa-user"></i>
        </a>
      </li>
      <li class="navbar-icon-container">
        <a href="/logout">
          <i class="fas fa-sign-out-alt"></i>
        </a>
      </li>
      <li class="navbar-icon-container">
        <a href="/conversations">
          <i class="fas fa-envelope"></i>
          <span class="notification-badge message-badge" id="messageBadge">5+</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- Profile Header -->
  <div class="profile-header">
    <div class="profile-avatar-container">
      <img class="profile-avatar" src="<%= user.dp || '/images/default-dp.png' %>" alt="Profile Picture" />

      <% if (currentUser && currentUser._id.toString() === user._id.toString()) { %>
        <!-- DP Upload -->
        <form action="/upload-dp" method="post" enctype="multipart/form-data" class="dp-form">
          <input type="file" name="dp" id="dp" accept="image/*" required />
          <label for="dp" class="custom-file-btn">Choose File</label>
          <button type="submit" class="dp-submit-btn">Change DP</button>
        </form>

        <!-- DP Delete -->
        <form action="/delete-dp" method="post" class="dp-delete-form">
          <button type="submit" class="dp-delete-btn">Delete DP</button>
        </form>
        
      <% } %>
    </div>

    <div class="profile-info">
      <h1 class="profile-name"><%= user.fullname %></h1>
      <p class="profile-handle">@<%= user.username %></p>
      <div class="profile-stats">
        <span class="profile-stat"><b><%= user.followers ? user.followers.length : 0 %></b> followers</span>
        <span class="profile-stat"><b><%= user.following ? user.following.length : 0 %></b> following</span>
      </div>
      <p class="profile-bio">
        <%= user.bio || "No bio yet." %>
      </p>

      <div class="profile-actions">
        <% if (isOwnProfile) { %>
          <!-- Follow Requests Button (only if there are pending requests) -->
          <% if (user.followRequests && user.followRequests.length > 0) { %>
            <a href="/follow-requests" class="profile-btn requests-btn">
              <i class="fa-solid fa-user-clock"></i> 
              Follow Requests (<%= user.followRequests.length %>)
            </a>
          <% } %>
          
          <a href="/share" class="profile-btn share-btn"><i class="fa-solid fa-arrow-up-from-bracket"></i> Share</a>
          <a href="/account-settings" class="profile-btn edit-btn"><i class="fa-solid fa-user-pen"></i> Edit profile</a>
          <a href="/logout" class="profile-btn logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a>
        <% } else if (currentUser) { %>
          <!-- Follow/Unfollow Button -->
          <% if (followStatus === 'following') { %>
            <button id="followBtn" class="profile-btn following-btn" data-user-id="<%= user._id %>" data-action="unfollow">
              <i class="fa-solid fa-user-check"></i> Following
            </button>
          <% } else if (followStatus === 'requested') { %>
            <button id="followBtn" class="profile-btn requested-btn" data-user-id="<%= user._id %>" data-action="cancel-request">
              <i class="fa-solid fa-clock"></i> Requested
            </button>
          <% } else { %>
            <button id="followBtn" class="profile-btn follow-btn" data-user-id="<%= user._id %>" data-action="follow">
              <i class="fa-solid fa-user-plus"></i> Follow
            </button>
          <% } %>

          <!-- Message Button with different states based on account type -->
          <% if (canMessage) { %>
            <button onclick="window.location.href='/chat/<%= user._id %>'" class="profile-btn chat-btn">
              <i class="fa-solid fa-envelope"></i> Message
            </button>
          <% } else if (followStatus === 'following') { %>
            <button onclick="window.location.href='/chat/<%= user._id %>'" class="profile-btn chat-btn">
              <i class="fa-solid fa-envelope"></i> Message
            </button>
          <% } else if (followStatus === 'requested') { %>
            <button class="profile-btn chat-btn disabled" disabled title="Message after follow request is accepted">
              <i class="fa-solid fa-envelope"></i> Message
            </button>
          <% } else if (user.isPrivate) { %>
            <button class="profile-btn chat-btn disabled" disabled title="Follow this private account to send messages">
              <i class="fa-solid fa-lock"></i> Message
            </button>
          <% } else { %>
            <button onclick="window.location.href='/chat/<%= user._id %>'" class="profile-btn chat-btn">
              <i class="fa-solid fa-envelope"></i> Message
            </button>
          <% } %>

          <!-- Share Profile -->
          <button class="profile-btn share-btn" onclick="shareProfile()">
            <i class="fa-solid fa-share"></i> Share
          </button>
        <% } else { %>
          <a href="/login" class="profile-btn follow-btn"><i class="fa-solid fa-sign-in-alt"></i> Login to Follow</a>
        <% } %>
      </div>
    </div>
  </div>

  <% if (currentUser && currentUser._id.toString() === user._id.toString()) { %>
    <!-- Enhanced Create Pin Section -->
    <div class="create-pin-section">
      <div class="create-pin-header">
        <h3><i class="fas fa-plus-circle"></i> Create a New Pin</h3>
        <p>Share your ideas with the world</p>
      </div>
      
      <form class="create-pin-form" action="/upload" method="POST" enctype="multipart/form-data">
        <div class="form-row">
          <div class="form-group">
            <label for="captionInput">Pin Title</label>
            <input type="text" id="captionInput" name="caption" placeholder="What's your pin about?" required>
          </div>
          
          <div class="form-group">
            <label for="descriptionInput">Description</label>
            <textarea id="descriptionInput" name="description" placeholder="Tell everyone more about this pin..." rows="3"></textarea>
          </div>
        </div>
        
        <div class="media-upload-section">
          <div class="file-input-wrapper">
            <input type="file" name="media" class="file-input" id="mediaInput" accept="image/*,video/*,audio/*" required>
            <label for="mediaInput" class="file-input-label">
              <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <div class="upload-text">
                <span class="upload-title">Choose your media</span>
                <span class="upload-subtitle">Upload image, video, or audio</span>
              </div>
            </label>
            <div class="file-preview" id="filePreview"></div>
          </div>
          
          <div class="voice-note-section">
            <div class="voice-recorder">
              <div class="voice-header">
                <i class="fas fa-microphone"></i>
                <span>Add Voice Note (Optional)</span>
              </div>
              <div class="voice-controls">
                <button id="recordBtn" type="button" class="voice-btn record-btn">
                  <i class="fas fa-circle"></i> Record
                </button>
                <button id="stopBtn" type="button" class="voice-btn stop-btn" disabled>
                  <i class="fas fa-stop"></i> Stop
                </button>
              </div>
              <audio id="audioPreview" controls style="display: none;"></audio>
              <input type="file" id="voiceFile" name="voice" hidden />
            </div>
          </div>
        </div>
        
        <button type="submit" class="create-pin-btn">
          <i class="fas fa-plus"></i> Create Pin
        </button>
      </form>
    </div>
  <% } %>

  <!-- Navigation -->
  <nav class="profile-nav">
    <a href="#" class="nav-item active" id="createdTab">Created</a>
    <a href="#" class="nav-item" id="savedTab">Saved</a>
  </nav>

  <!-- Created Posts -->
  <main class="pin-grid" id="createdGrid">
    <% if (canViewPosts) { %>
      <% if (user.posts && user.posts.length > 0) { %>
        <% user.posts.forEach(post => { %>
          <div class="pin-card">
            <% if (post.fileType === "image") { %>
              <img src="<%= post.fileUrl %>" alt="User upload" />
            <% } else if (post.fileType === "video") { %>
              <video controls>
                <source src="<%= post.fileUrl %>" type="video/mp4" />
              </video>
            <% } %>

            <% if (post.voiceUrl) { %>
              <div class="audio-post">
                <audio controls>
                  <source src="<%= post.voiceUrl %>" type="audio/webm" />
                </audio>
              </div>
            <% } %>

            <div class="pin-content">
              <p class="pin-caption"><%= post.caption || "No caption" %></p>
              <% if (currentUser) { %>
                <form action="/post/<%= post._id %>/save" method="POST">
                  <button type="submit" class="save-btn"><i class="fa-regular fa-bookmark"></i> Save</button>
                </form>
              <% } %>

              <% if (currentUser && currentUser._id.toString() === user._id.toString()) { %>
                <!-- Delete post only for self -->
                <form action="/post/<%= post._id %>/delete" method="POST">
                  <button type="submit" class="delete-btn"><i class="fa-solid fa-trash"></i> Delete</button>
                </form>
              <% } %>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="no-posts"><p>No posts yet.</p></div>
      <% } %>
    <% } else { %>
      <!-- Private account - posts hidden -->
      <div class="private-account-message">
        <div class="private-icon">
          <i class="fas fa-lock"></i>
        </div>
        <h3>This account is private</h3>
        <p>Follow this account to see their posts and photos.</p>
        <% if (followStatus === 'requested') { %>
          <p class="request-status">Your follow request is pending.</p>
        <% } %>
      </div>
    <% } %>
  </main>

  <!-- Saved Posts -->
  <!-- Replace your entire Saved Posts block with this one -->

<!-- Saved Posts (exact same card+grid structure as Created) -->
<main class="pin-grid" id="savedGrid" style="display:none;">
  <% if (user.savedPosts && user.savedPosts.length > 0) { %>
    <% user.savedPosts.forEach(post => { %>
      <div class="pin-card">
        <% if (post.fileType === "image") { %>
          <img src="<%= post.fileUrl %>" alt="Saved post" />
        <% } else if (post.fileType === "video") { %>
          <video controls>
            <source src="<%= post.fileUrl %>" type="video/mp4" />
          </video>
        <% } %>

        <% if (post.voiceUrl) { %>
          <div class="audio-post">
            <audio controls>
              <source src="<%= post.voiceUrl %>" type="audio/webm" />
            </audio>
          </div>
        <% } %>

        <div class="pin-content">
          <p class="pin-caption"><%= post.caption || "No caption" %></p>

          <!-- Actions row: mirror Created section -->
          <div style="display:flex; gap:8px; align-items:center;">
            <!-- Unsave (so behavior mirrors Save in Created) -->
            <form action="/post/<%= post._id %>/unsave" method="POST">
              <button type="submit" class="save-btn">
                <i class="fa-solid fa-bookmark"></i> Unsave
              </button>
            </form>

            <% if (currentUser && currentUser._id.toString() === user._id.toString()) { %>
              <!-- Optional: delete your own post even from Saved view (same as Created) -->
              <form action="/post/<%= post._id %>/delete" method="POST">
                <button type="submit" class="delete-btn">
                  <i class="fa-solid fa-trash"></i> Delete
                </button>
              </form>
            <% } %>
          </div>
        </div>
      </div>
    <% }) %>
  <% } else { %>
    <div class="no-posts"><p>No saved posts yet.</p></div>
  <% } %>
</main>

<!-- Nothing to change in CSS: Saved uses the same .pin-grid, .pin-card, .pin-content, .pin-caption, .save-btn, .delete-btn classes as Created -->

  <!-- Enhanced Scripts -->
  <script>
    // Voice recorder functionality
    let mediaRecorder, audioChunks = [];
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const audioPreview = document.getElementById("audioPreview");
    const audioFileInput = document.getElementById("voiceFile");

    if(recordBtn && stopBtn){
      recordBtn.addEventListener("click", async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.start();

          recordBtn.disabled = true;
          stopBtn.disabled = false;
          recordBtn.innerHTML = '<i class="fas fa-circle"></i> Recording...';
          audioPreview.style.display = "none";

          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) audioChunks.push(e.data);
          };

          mediaRecorder.onstop = () => {
            if (audioChunks.length === 0) return;
            const blob = new Blob(audioChunks, { type: "audio/webm" });
            const url = URL.createObjectURL(blob);
            audioPreview.src = url;
            audioPreview.style.display = "block";

            const file = new File([blob], "voice-note.webm", { type: "audio/webm" });
            const dt = new DataTransfer();
            dt.items.add(file);
            audioFileInput.files = dt.files;
            
            recordBtn.innerHTML = '<i class="fas fa-circle"></i> Record';
          };
        } catch (err) {
          alert("Microphone access denied or not available.");
          console.error("Microphone error:", err);
        }
      });

      stopBtn.addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        recordBtn.innerHTML = '<i class="fas fa-circle"></i> Record';
      });
    }

    // File input preview
    const mediaInput = document.getElementById('mediaInput');
    const filePreview = document.getElementById('filePreview');
    
    if (mediaInput) {
      mediaInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const fileName = file.name;
          const fileType = file.type.split('/')[0];
          let icon = 'fas fa-file';
          
          if (fileType === 'image') icon = 'fas fa-image';
          else if (fileType === 'video') icon = 'fas fa-video';
          else if (fileType === 'audio') icon = 'fas fa-music';
          
          filePreview.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
              <i class="${icon}" style="color: var(--pinterest-red, #e60023); font-size: 20px;"></i>
              <div>
                <div style="font-weight: 600; color: #333;">${fileName}</div>
                <div style="font-size: 12px; color: #666;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
              </div>
            </div>
          `;
          filePreview.classList.add('active');
          
          // Update upload label
          const uploadTitle = document.querySelector('.upload-title');
          const uploadSubtitle = document.querySelector('.upload-subtitle');
          if (uploadTitle && uploadSubtitle) {
            uploadTitle.textContent = 'File selected!';
            uploadSubtitle.textContent = 'Click to change file';
          }
        }
      });
    }
  </script>

  <!-- Toggle Script -->
  <script>
    const createdTab = document.getElementById("createdTab");
    const savedTab = document.getElementById("savedTab");
    const createdGrid = document.getElementById("createdGrid");
    const savedGrid = document.getElementById("savedGrid");

    createdTab.addEventListener("click", (e) => {
      e.preventDefault();
      createdTab.classList.add("active");
      savedTab.classList.remove("active");
      createdGrid.style.display = "grid";
      savedGrid.style.display = "none";
    });

    savedTab.addEventListener("click", (e) => {
      e.preventDefault();
      savedTab.classList.add("active");
      createdTab.classList.remove("active");
      savedGrid.style.display = "grid";
      createdGrid.style.display = "none";
    });
  </script>

  <!-- Search Script -->
  <script>
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");

    let searchTimeout;

    searchInput.addEventListener("input", async (e) => {
      const query = e.target.value.trim();

      // Clear previous timeout
      clearTimeout(searchTimeout);

      if (query.length === 0) {
        searchResults.innerHTML = "";
        searchResults.style.display = "none";
        return;
      }

      // Debounce search
      searchTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`/search-users?q=${encodeURIComponent(query)}`);
          const users = await res.json();

          if (users.length === 0) {
            searchResults.innerHTML = "<p class='no-result'>No users found</p>";
          } else {
            searchResults.innerHTML = users.map(user => `
              <div class="search-item" onclick="window.location.href='/profile/${user._id}'">
                <img src="${user.dp || '/images/default-dp.png'}" alt="Profile Picture" />
                <div>
                  <strong>${user.fullname}</strong>
                  <p>@${user.username}</p>
                </div>
              </div>
            `).join("");
          }
          searchResults.style.display = "block";
        } catch (error) {
          console.error("Search error:", error);
          searchResults.innerHTML = "<p class='no-result'>Search error</p>";
          searchResults.style.display = "block";
        }
      }, 300);
    });

    // Hide search results when clicking outside
    document.addEventListener("click", (e) => {
      if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = "none";
      }
    });

    // Notification Counts Function
    async function updateNotificationCounts() {
      try {
        const response = await fetch('/notification-counts');
        const data = await response.json();
        
        const notificationBadge = document.getElementById('notificationBadge');
        const messageBadge = document.getElementById('messageBadge');
        
        // Update notification badge
        if (data.notifications > 0) {
          notificationBadge.textContent = data.notifications > 9 ? '9+' : data.notifications.toString();
          notificationBadge.classList.remove('hidden');
        } else {
          notificationBadge.classList.add('hidden');
        }
        
        // Update message badge
        if (data.messages > 0) {
          messageBadge.textContent = data.messages > 9 ? '9+' : data.messages.toString();
          messageBadge.classList.remove('hidden');
        } else {
          messageBadge.classList.add('hidden');
        }
        
      } catch (error) {
        console.error('Error fetching notification counts:', error);
      }
    }

    // Update counts on page load
    updateNotificationCounts();

    // Update counts every 30 seconds
    setInterval(updateNotificationCounts, 30000);

    // Follow/Unfollow functionality
    const followBtn = document.getElementById('followBtn');
    if (followBtn) {
      followBtn.addEventListener('click', async function() {
        const userId = this.dataset.userId;
        const action = this.dataset.action;
        
        try {
          let response;
          if (action === 'follow') {
            response = await fetch(`/follow/follow/${userId}`, { method: 'POST' });
          } else if (action === 'unfollow' || action === 'cancel-request') {
            response = await fetch(`/follow/unfollow/${userId}`, { method: 'POST' });
          }
          
          const data = await response.json();
          
          if (data.success) {
            // Update button based on response
            updateFollowButton(data.status, data.isPrivate);
            showToast(data.message);
            
            // Update follower count
            if (data.status === 'following') {
              incrementFollowerCount();
            } else if (data.status === 'not_following') {
              decrementFollowerCount();
            }
          } else {
            showToast(data.message, 'error');
          }
        } catch (error) {
          console.error('Follow error:', error);
          showToast('Something went wrong. Please try again.', 'error');
        }
      });
    }

    function updateFollowButton(status, isPrivate) {
      const followBtn = document.getElementById('followBtn');
      if (!followBtn) return;

      if (status === 'following') {
        followBtn.className = 'profile-btn following-btn';
        followBtn.innerHTML = '<i class="fa-solid fa-user-check"></i> Following';
        followBtn.dataset.action = 'unfollow';
        
        // Enable message button if it exists
        const chatBtn = document.querySelector('.chat-btn');
        if (chatBtn && chatBtn.disabled) {
          chatBtn.disabled = false;
          chatBtn.classList.remove('disabled');
          chatBtn.title = '';
          chatBtn.onclick = () => window.location.href = `/chat/${followBtn.dataset.userId}`;
          chatBtn.innerHTML = '<i class="fa-solid fa-envelope"></i> Message';
        }
      } else if (status === 'requested') {
        followBtn.className = 'profile-btn requested-btn';
        followBtn.innerHTML = '<i class="fa-solid fa-clock"></i> Requested';
        followBtn.dataset.action = 'cancel-request';
        
        // Update message button for pending request
        const chatBtn = document.querySelector('.chat-btn');
        if (chatBtn) {
          chatBtn.disabled = true;
          chatBtn.classList.add('disabled');
          chatBtn.title = 'Message after follow request is accepted';
          chatBtn.onclick = null;
          if (isPrivate) {
            chatBtn.innerHTML = '<i class="fa-solid fa-clock"></i> Pending';
          }
        }
      } else {
        followBtn.className = 'profile-btn follow-btn';
        followBtn.innerHTML = '<i class="fa-solid fa-user-plus"></i> Follow';
        followBtn.dataset.action = 'follow';
        
        // Update message button based on account type
        const chatBtn = document.querySelector('.chat-btn');
        if (chatBtn) {
          if (isPrivate) {
            chatBtn.disabled = true;
            chatBtn.classList.add('disabled');
            chatBtn.title = 'Follow this private account to send messages';
            chatBtn.innerHTML = '<i class="fa-solid fa-lock"></i> Message';
            chatBtn.onclick = null;
          } else {
            // Public account - can message without following
            chatBtn.disabled = false;
            chatBtn.classList.remove('disabled');
            chatBtn.title = '';
            chatBtn.onclick = () => window.location.href = `/chat/${followBtn.dataset.userId}`;
            chatBtn.innerHTML = '<i class="fa-solid fa-envelope"></i> Message';
          }
        }
      }
    }

    function incrementFollowerCount() {
      const followerStat = document.querySelector('.profile-stat');
      if (followerStat) {
        const currentCount = parseInt(followerStat.querySelector('b').textContent);
        followerStat.querySelector('b').textContent = currentCount + 1;
      }
    }

    function decrementFollowerCount() {
      const followerStat = document.querySelector('.profile-stat');
      if (followerStat) {
        const currentCount = parseInt(followerStat.querySelector('b').textContent);
        followerStat.querySelector('b').textContent = Math.max(0, currentCount - 1);
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      
      const style = document.createElement('style');
      style.textContent = `
        .toast {
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 12px 24px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 10000;
          animation: slideUp 0.3s ease-out;
        }
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        @keyframes slideUp {
          from { transform: translateY(100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
      `;
      
      if (!document.querySelector('style[data-toast]')) {
        style.setAttribute('data-toast', 'true');
        document.head.appendChild(style);
      }
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideUp 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function shareProfile() {
      const profileUrl = window.location.href;
      const userName = '<%= user.fullname %>';
      
      if (navigator.share) {
        navigator.share({
          title: `${userName}'s Profile`,
          text: `Check out ${userName}'s profile on PostKaro`,
          url: profileUrl
        }).catch(() => {});
      } else {
        navigator.clipboard.writeText(profileUrl).then(() => {
          showToast('Profile link copied to clipboard!');
        });
      }
    }
  </script>
</body>
</html>
