<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home - Pinterest</title>
  <link rel="stylesheet" href="/stylesheets/explore.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .pinterest-feed-header {
      text-align: center;
      padding: 32px 24px;
      background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
      color: white;
      margin-bottom: 32px;
    }
    
    .pinterest-feed-header h1 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .create-pin-section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin: 0 auto 32px;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .create-pin-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .create-pin-form input[type="text"],
    .create-pin-form textarea {
      padding: 12px 16px;
      border: 2px solid #e1e1e1;
      border-radius: 12px;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.2s ease;
    }
    
    .create-pin-form input[type="text"]:focus,
    .create-pin-form textarea:focus {
      outline: none;
      border-color: var(--pinterest-red);
    }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      border: 2px dashed #e1e1e1;
      border-radius: 12px;
      background: #f9f9f9;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .file-input-label:hover {
      border-color: var(--pinterest-red);
      background: #fff5f5;
    }
    
    .create-pin-btn {
      background: var(--pinterest-red);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .create-pin-btn:hover {
      background: var(--pinterest-dark-red);
      transform: scale(1.02);
    }
  </style>
</head>
<body>

  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-logo">
      <a href="/feed"><i class="fab fa-pinterest"></i>Pinterest</a>
    </div>
    
    <ul class="navbar-types">
      <li><a href="/feed" class="nav-link active">Home</a></li>
      <li><a href="/explore" class="nav-link">Explore</a></li>
      <li><a href="/dashboard" class="nav-link">Dashboard</a></li>
    </ul>
    
    <div class="navbar-search">
      <input type="text" id="searchInput" placeholder="Search for pins, users..." />
      <div id="searchResults" class="search-results"></div>
    </div>
    
    <ul class="navbar-actions">
      <li class="navbar-icon-container">
        <a href="/notifications" class="nav-link">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notificationBadge">0</span>
        </a>
      </li>
      <li class="navbar-icon-container">
        <a href="/conversations" class="nav-link">
          <i class="fas fa-comment"></i>
          <span class="notification-badge message-badge" id="messageBadge">0</span>
        </a>
      </li>
      <li><a href="/profile/<%= user ? user._id : '' %>" class="nav-link"><i class="fas fa-user"></i></a></li>
      <li><a href="/logout" class="nav-link"><i class="fas fa-sign-out-alt"></i></a></li>
    </ul>
  </nav>

  <!-- Feed Header -->
  <div class="pinterest-feed-header">
    <h1>Welcome to Your Feed</h1>
    <p>Discover amazing pins from people you follow</p>
  </div>

  <!-- Create Pin Section -->
  <div class="create-pin-section">
    <h3 style="margin-bottom: 16px; color: var(--pinterest-black);">Create a New Pin</h3>
    <form class="create-pin-form" action="/upload" method="POST" enctype="multipart/form-data">
      <input type="text" name="caption" placeholder="What's your pin about?" required>
      <textarea name="description" placeholder="Tell everyone more about this pin..." rows="3"></textarea>
      
      <div class="file-input-wrapper">
        <input type="file" name="media" class="file-input" accept="image/*,video/*,audio/*" required>
        <label class="file-input-label">
          <i class="fas fa-cloud-upload-alt"></i>
          <span>Choose image, video, or audio</span>
        </label>
      </div>
      
      <button type="submit" class="create-pin-btn">
        <i class="fas fa-plus"></i> Create Pin
      </button>
    </form>
  </div>

  <!-- Pinterest Masonry Layout -->
  <% if (posts && posts.length > 0) { %>
    <div class="pinterest-container" id="pinterestContainer">
      <% posts.forEach(function(post) { %>
        <div class="pin-card">
          <div class="pin-media">
            <% if (post.fileType === "image") { %>
              <img src="<%= post.fileUrl %>" alt="<%= post.caption || 'Pin image' %>" loading="lazy">
            <% } else if (post.fileType === "video") { %>
              <video muted autoplay loop playsInline>
                <source src="<%= post.fileUrl %>" type="video/webm">
                Your browser does not support the video tag.
              </video>
            <% } else { %>
              <div class="audio-pin">
                <i class="fas fa-music"></i>
                <p>Media Pin</p>
              </div>
            <% } %>
            
            <div class="pin-overlay">
              <div class="pin-user">
                <a href="/profile/<%= post.user ? post.user._id : '' %>" class="user-link">
                  <img src="<%= (post.user && post.user.dp) ? post.user.dp : '/images/default-avatar.svg' %>" alt="<%= post.user ? post.user.username : 'User' %>">
                  <span><%= post.user ? post.user.username : 'Unknown' %></span>
                </a>
              </div>
              <div class="pin-actions">
                <form action="/post/<%= post._id %>/save" method="POST" style="display:inline;">
                  <button type="submit" class="save-btn">Save</button>
                </form>
                <button class="share-btn" title="Share"><i class="fas fa-share"></i></button>
                <button class="more-btn" title="More options"><i class="fas fa-ellipsis-h"></i></button>
              </div>
            </div>
          </div>
          
          <div class="pin-info">
            <h3 class="pin-title"><%= post.caption || 'Untitled Pin' %></h3>
            <div class="pin-meta">
              <img src="<%= (post.user && post.user.dp) ? post.user.dp : '/images/default-avatar.svg' %>" alt="<%= post.user ? post.user.username : 'User' %>">
              <span><%= post.user ? post.user.username : 'Unknown' %></span>
              <span>•</span>
              <span><%= Math.floor((Date.now() - new Date(post.createdAt).getTime()) / (1000 * 60 * 60 * 24)) %>d ago</span>
            </div>
            
            <% if (post.description) { %>
              <p style="margin-top: 8px; color: var(--pinterest-grey); font-size: 14px; line-height: 1.4;">
                <%= post.description %>
              </p>
            <% } %>
          </div>
          
          <% if (post.voiceUrl) { %>
            <div class="voice-note">
              <i class="fas fa-microphone"></i>
              <audio controls>
                <source src="<%= post.voiceUrl %>" type="audio/webm">
                Your browser does not support the audio element.
              </audio>
            </div>
          <% } %>
        </div>
      <% }); %>
    </div>
  <% } else { %>
    <div class="empty-state">
      <i class="fas fa-plus-circle"></i>
      <h3>No pins in your feed yet</h3>
      <p>Start following people or create your first pin to see content here!</p>
    </div>
  <% } %>
  <script>
    // Global variables for infinite scroll
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;

    // Initialize boomerang videos
    function initBoomerangVideos() {
      const videos = document.querySelectorAll('.pin-card video');
      videos.forEach(video => {
        video.muted = true; // Autoplay requires muted videos
        video.loop = false; // We'll handle looping manually for boomerang effect
        video.autoplay = true;
        video.playsInline = true;
        
        // Boomerang effect - play forward then reverse
        video.addEventListener('ended', function() {
          this.currentTime = 0;
          this.play();
        });
        
        // Add hover effect to play/pause
        video.parentElement.addEventListener('mouseenter', () => {
          video.play();
        });
        
        video.parentElement.addEventListener('mouseleave', () => {
          video.pause();
        });
        
        // Intersection Observer for auto-play when in viewport
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              video.play();
            } else {
              video.pause();
            }
          });
        }, { threshold: 0.5 });
        
        observer.observe(video);
      });
    }

    // Create pin card HTML
    function createPinCard(post) {
      const timeAgo = Math.floor((Date.now() - new Date(post.createdAt).getTime()) / (1000 * 60 * 60 * 24));
      const userDp = (post.user && post.user.dp) ? post.user.dp : '/images/default-avatar.svg';
      const username = post.user ? post.user.username : 'Unknown';
      const caption = post.caption || 'Untitled Pin';
      
      let mediaHtml = '';
      if (post.fileType === "image") {
        mediaHtml = `<img src="${post.fileUrl}" alt="${caption}" loading="lazy">`;
      } else if (post.fileType === "video") {
        mediaHtml = `
          <video muted autoplay loop playsInline>
            <source src="${post.fileUrl}" type="video/webm">
            Your browser does not support the video tag.
          </video>`;
      } else {
        mediaHtml = `
          <div class="audio-pin">
            <i class="fas fa-music"></i>
            <p>Media Pin</p>
          </div>`;
      }
      
      return `
        <div class="pin-card fade-in">
          <div class="pin-media">
            ${mediaHtml}
            <div class="pin-overlay">
              <div class="pin-user">
                <a href="/profile/${post.user ? post.user._id : ''}" class="user-link">
                  <img src="${userDp}" alt="${username}">
                  <span>${username}</span>
                </a>
              </div>
              <div class="pin-actions">
                <form action="/post/${post._id}/save" method="POST" style="display:inline;">
                  <button type="submit" class="save-btn">Save</button>
                </form>
                <button class="share-btn" title="Share"><i class="fas fa-share"></i></button>
                <button class="more-btn" title="More options"><i class="fas fa-ellipsis-h"></i></button>
              </div>
            </div>
          </div>
          <div class="pin-info">
            <h3 class="pin-title">${caption}</h3>
            <div class="pin-meta">
              <img src="${userDp}" alt="${username}">
              <span>${username}</span>
              <span>•</span>
              <span>${timeAgo}d ago</span>
            </div>
            ${post.description ? `<p style="margin-top: 8px; color: var(--pinterest-grey); font-size: 14px; line-height: 1.4;">${post.description}</p>` : ''}
          </div>
        </div>`;
    }

    // Load more posts for infinite scroll
    async function loadMorePosts() {
      if (isLoading || !hasMore) return;
      
      isLoading = true;
      showLoadingSpinner();
      
      try {
        const response = await fetch(`/api/posts?page=${currentPage + 1}&limit=20`);
        const data = await response.json();
        
        if (data.posts && data.posts.length > 0) {
          const container = document.getElementById('pinterestContainer');
          
          data.posts.forEach((post, index) => {
            const pinCard = document.createElement('div');
            pinCard.innerHTML = createPinCard(post);
            pinCard.style.animationDelay = `${index * 0.1}s`;
            container.appendChild(pinCard.firstElementChild);
          });
          
          // Initialize boomerang videos for new posts
          initBoomerangVideos();
          
          currentPage++;
          hasMore = data.hasMore;
        } else {
          hasMore = false;
        }
      } catch (error) {
        console.error('Error loading more posts:', error);
      } finally {
        isLoading = false;
        hideLoadingSpinner();
      }
    }

    // Show loading spinner
    function showLoadingSpinner() {
      let spinner = document.getElementById('loadingSpinner');
      if (!spinner) {
        spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid var(--pinterest-red); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 16px; color: var(--pinterest-grey);">Loading more pins...</p>
          </div>
        `;
        document.body.appendChild(spinner);
      }
      spinner.style.display = 'block';
    }

    // Hide loading spinner
    function hideLoadingSpinner() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.style.display = 'none';
      }
    }

    // Infinite scroll observer
    function initInfiniteScroll() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && hasMore && !isLoading) {
            loadMorePosts();
          }
        });
      }, {
        rootMargin: '200px'
      });

      // Create sentinel element
      const sentinel = document.createElement('div');
      sentinel.id = 'scrollSentinel';
      sentinel.style.height = '1px';
      document.body.appendChild(sentinel);
      
      observer.observe(sentinel);
    }

    // Search functionality
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");

    if (searchInput) {
      searchInput.addEventListener("input", async () => {
        const query = searchInput.value.trim();

        if (!query) {
          searchResults.innerHTML = "";
          searchResults.style.display = 'none';
          return;
        }

        try {
          const res = await fetch(`/search-users?q=${encodeURIComponent(query)}`);
          const users = await res.json();

          if (users.length === 0) {
            searchResults.innerHTML = "<div class='search-item'><span>No users found</span></div>";
          } else {
            searchResults.innerHTML = users.map(user => `
              <div class="search-item" onclick="window.location.href='/profile/${user._id}'">
                <img src="${user.dp || '/images/default-avatar.svg'}" alt="${user.username}">
                <span>${user.fullname || user.username} (@${user.username})</span>
              </div>
            `).join("");
          }
          searchResults.style.display = 'block';
        } catch (err) {
          console.error(err);
          searchResults.innerHTML = "<div class='search-item'><span>Error searching users</span></div>";
          searchResults.style.display = 'block';
        }
      });

      // Hide search results when clicking outside
      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.style.display = 'none';
        }
      });
    }

    // Notification Counts Function
    async function updateNotificationCounts() {
      try {
        const response = await fetch('/notification-counts');
        const data = await response.json();
        
        const notificationBadge = document.getElementById('notificationBadge');
        const messageBadge = document.getElementById('messageBadge');
        
        if (notificationBadge && data.notifications > 0) {
          notificationBadge.textContent = data.notifications > 99 ? '99+' : data.notifications.toString();
          notificationBadge.classList.remove('hidden');
        } else if (notificationBadge) {
          notificationBadge.classList.add('hidden');
        }
        
        if (messageBadge && data.messages > 0) {
          messageBadge.textContent = data.messages > 99 ? '99+' : data.messages.toString();
          messageBadge.classList.remove('hidden');
        } else if (messageBadge) {
          messageBadge.classList.add('hidden');
        }
        
      } catch (error) {
        console.error('Error fetching notification counts:', error);
      }
    }

    // File input preview
    const fileInput = document.querySelector('.file-input');
    const fileLabel = document.querySelector('.file-input-label span');
    
    if (fileInput) {
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const fileName = file.name;
          const fileType = file.type.split('/')[0];
          let icon = 'fas fa-file';
          
          if (fileType === 'image') icon = 'fas fa-image';
          else if (fileType === 'video') icon = 'fas fa-video';
          else if (fileType === 'audio') icon = 'fas fa-music';
          
          fileLabel.innerHTML = `<i class="${icon}"></i> ${fileName}`;
        }
      });
    }

    // Pin interaction handlers
    document.addEventListener('click', function(e) {
      if (e.target.closest('.share-btn')) {
        e.preventDefault();
        if (navigator.share) {
          navigator.share({
            title: 'Check out this pin!',
            url: window.location.href
          });
        } else {
          navigator.clipboard.writeText(window.location.href);
          alert('Link copied to clipboard!');
        }
      }
    });

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function() {
      updateNotificationCounts();
      initBoomerangVideos();
      initInfiniteScroll();
      
      // Initialize Pinterest layout with animations
      const container = document.getElementById('pinterestContainer');
      if (container) {
        const cards = container.querySelectorAll('.pin-card');
        cards.forEach((card, index) => {
          card.style.animationDelay = `${index * 0.1}s`;
          card.classList.add('fade-in');
        });
      }
      
      // Refresh notification counts every 30 seconds
      setInterval(updateNotificationCounts, 30000);
    });

    // Add pulsing animation to notification badges
    setInterval(() => {
      const badges = document.querySelectorAll('.notification-badge:not(.hidden)');
      badges.forEach(badge => {
        badge.style.animation = 'pulse 1s ease-in-out';
        setTimeout(() => badge.style.animation = '', 1000);
      });
    }, 5000);
  </script>

  <style>
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 64px 24px;
      color: var(--pinterest-grey);
    }
    
    .empty-state i {
      font-size: 64px;
      margin-bottom: 24px;
      color: var(--pinterest-light-grey);
    }
    
    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 16px;
      color: var(--pinterest-black);
    }
    
    .empty-state p {
      font-size: 16px;
      max-width: 400px;
      margin: 0 auto;
    }
    
    /* Video boomerang effects */
    .pin-card video {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .pin-card:hover video {
      transform: scale(1.02);
    }
    
    /* Loading spinner */
    #loadingSpinner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
    }
  </style>

</body>
</html>
