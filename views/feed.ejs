<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feed</title>
  <link rel="stylesheet" href="/stylesheets/feed.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>

  <!-- ✅ Navbar directly included -->
  <nav class="navbar">
    <!-- Logo -->
    <div class="navbar-logo">
      <a href="/"><i class="fab fa-pinterest"></i> PostKaro</a>
    </div>

    <!-- Types -->
    <ul class="navbar-types">
      <li><a href="/" class="active">Home</a></li>
      <li><a href="/explore">Explore</a></li>
      <li><a href="/today">Today</a></li>
    </ul>

    <!-- Search -->
    <div class="navbar-search">
  <input type="text" id="searchInput" placeholder="Search people..." autocomplete="off" />
  <div id="searchResults" class="search-results"></div>
</div>

    <!-- Actions -->
    <ul class="navbar-actions">
      <li><a href="/notifications"><i class="fas fa-bell"></i></a></li>
      <li><a href="/profile"><i class="fas fa-user"></i></a></li>
      <li><a href="/logout"><i class="fas fa-sign-out-alt"></i></a></li>
    </ul>
  </nav>

  <!-- ✅ Feed masonry layout -->
  <div class="container">
    <% // Break posts into 4 columns for Pinterest-style layout %>
    <% for (let col = 0; col < 4; col++) { %>
      <div class="column">
        <% posts.filter((p, i) => i % 4 === col).forEach(post => { %>
          <div class="content-wrapper">
            
            <!-- Image/Video/Audio Wrapper -->
            <div class="image-wrapper">
              <!-- Overlay on hover -->
              <div class="overlay">
                <div class="left">
                  <p><%= post.user?.username || "Unknown" %></p>
                  <!-- Save button -->
                  <form action="/post/<%= post._id %>/save" method="POST" style="display:inline;">
                    <button type="submit" class="save">Save</button>
                  </form>
                </div>
                <div class="right">
                  <!-- Go to profile -->
                  <a href="/profile/<%= post.user?._id %>" class="spheric-button">
                    Profile
                  </a>
                  <!-- Share button -->
                  <button class="round-button">
                    <i class="fas fa-share"></i>
                  </button>
                  <!-- More options -->
                  <button class="round-button">
                    <i class="fas fa-ellipsis-h"></i>
                  </button>
                </div>
              </div>

              <!-- Media rendering -->
              <% if (post.fileType === "image") { %>
                <img src="<%= post.fileUrl %>" alt="post">
              <% } else if (post.fileType === "video") { %>
                <video src="<%= post.fileUrl %>" controls></video>
              <% } else if (post.fileType === "audio") { %>
                <audio src="<%= post.fileUrl %>" controls></audio>
              <% } %>
            </div>

            <!-- Caption -->
            <p class="caption"><%= post.caption %></p>

            <!-- Optional voice note -->
            <% if (post.voiceUrl) { %>
              <audio src="<%= post.voiceUrl %>" controls></audio>
            <% } %>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
  <script>
  const searchInput = document.getElementById("searchInput");
  const searchResults = document.getElementById("searchResults");

  searchInput.addEventListener("input", async () => {
    const query = searchInput.value.trim();

    if (!query) {
      searchResults.innerHTML = "";
      return;
    }

    try {
      const res = await fetch(`/search-users?q=${encodeURIComponent(query)}`);
      const users = await res.json();

      if (users.length === 0) {
        searchResults.innerHTML = "<p class='no-result'>No users found</p>";
        return;
      }

      searchResults.innerHTML = users.map(user => `
        <div class="search-item" onclick="window.location.href='/profile/${user._id}'">
          <i class="fas fa-user"></i>
          <span>${user.fullname} (@${user.username})</span>
        </div>
      `).join("");
    } catch (err) {
      console.error(err);
    }
  });
</script>

</body>
</html>
