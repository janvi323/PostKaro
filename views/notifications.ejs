<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifications - PostKaro</title>
  <link rel="stylesheet" href="/stylesheets/explore.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .notifications-container {
      max-width: 600px;
      margin: 80px auto 40px;
      padding: 0 20px;
    }

    .notifications-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .notifications-header h1 {
      font-size: 32px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .notifications-section {
      margin-bottom: 40px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e60023;
      display: inline-block;
    }

    .notification-item {
      display: flex;
      align-items: center;
      padding: 16px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }

    .notification-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .notification-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 16px;
      border: 2px solid #e1e8ed;
    }

    .notification-content {
      flex: 1;
    }

    .notification-user {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .notification-bio {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .notification-actions {
      display: flex;
      gap: 12px;
    }

    .btn-accept, .btn-decline {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .btn-accept {
      background: #e60023;
      color: white;
    }

    .btn-accept:hover {
      background: #c4001a;
    }

    .btn-decline {
      background: #767676;
      color: white;
    }

    .btn-decline:hover {
      background: #5a5a5a;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state i {
      font-size: 64px;
      color: #ddd;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 20px;
      color: #333;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 16px;
    }

    .pending-indicator {
      color: #e60023;
      font-size: 12px;
      font-weight: 500;
      background: rgba(230, 0, 35, 0.1);
      padding: 4px 8px;
      border-radius: 12px;
      margin-left: 8px;
    }

    @media (max-width: 768px) {
      .notifications-container {
        margin-top: 100px;
        padding: 0 16px;
      }

      .notification-item {
        flex-direction: column;
        text-align: center;
      }

      .notification-avatar {
        margin-right: 0;
        margin-bottom: 12px;
      }

      .notification-actions {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Include navbar -->
  <%- include('partials/navbar') %>

  <div class="notifications-container">
    <div class="notifications-header">
      <h1><i class="fas fa-bell"></i> Notifications</h1>
    </div>

    <!-- Follow Requests Section -->
    <div class="notifications-section">
      <h2 class="section-title">
        Follow Requests
        <% if (followRequests && followRequests.length > 0) { %>
          <span class="pending-indicator"><%= followRequests.length %> pending</span>
        <% } %>
      </h2>

      <% if (followRequests && followRequests.length > 0) { %>
        <% followRequests.forEach(function(requester) { %>
          <div class="notification-item" data-user-id="<%= requester._id %>">
            <img src="/images/dp/<%= requester.profilePicture || 'default.png' %>" 
                 alt="<%= requester.username %>" 
                 class="notification-avatar">
            
            <div class="notification-content">
              <div class="notification-user">@<%= requester.username %></div>
              <% if (requester.bio) { %>
                <div class="notification-bio"><%= requester.bio %></div>
              <% } %>
              
              <div class="notification-actions">
                <button class="btn-accept" onclick="handleFollowRequest('<%= requester._id %>', 'accept')">
                  <i class="fas fa-check"></i> Accept
                </button>
                <button class="btn-decline" onclick="handleFollowRequest('<%= requester._id %>', 'decline')">
                  <i class="fas fa-times"></i> Decline
                </button>
              </div>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="empty-state">
          <i class="fas fa-user-plus"></i>
          <h3>No follow requests</h3>
          <p>When someone requests to follow you, they'll appear here.</p>
        </div>
      <% } %>
    </div>

    <!-- Sent Requests Section (optional) -->
    <% if (sentRequests && sentRequests.length > 0) { %>
      <div class="notifications-section">
        <h2 class="section-title">
          Sent Requests
          <span class="pending-indicator"><%= sentRequests.length %> pending</span>
        </h2>

        <% sentRequests.forEach(function(recipient) { %>
          <div class="notification-item">
            <img src="/images/dp/<%= recipient.profilePicture || 'default.png' %>" 
                 alt="<%= recipient.username %>" 
                 class="notification-avatar">
            
            <div class="notification-content">
              <div class="notification-user">@<%= recipient.username %></div>
              <% if (recipient.bio) { %>
                <div class="notification-bio"><%= recipient.bio %></div>
              <% } %>
              <div style="color: #666; font-size: 14px; margin-top: 8px;">
                <i class="fas fa-clock"></i> Request pending
              </div>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>
  </div>

  <script>
    async function handleFollowRequest(userId, action) {
      try {
        const response = await fetch(`/notifications/${action}-request/${userId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success) {
          // Remove the notification item from the page
          const notificationItem = document.querySelector(`[data-user-id="${userId}"]`);
          if (notificationItem) {
            notificationItem.style.opacity = '0';
            notificationItem.style.transform = 'translateX(-20px)';
            setTimeout(() => {
              notificationItem.remove();
              
              // Check if this was the last follow request
              const remainingRequests = document.querySelectorAll('[data-user-id]');
              if (remainingRequests.length === 0) {
                // Show empty state
                const section = document.querySelector('.notifications-section');
                const emptyState = `
                  <div class="empty-state">
                    <i class="fas fa-user-plus"></i>
                    <h3>No follow requests</h3>
                    <p>When someone requests to follow you, they'll appear here.</p>
                  </div>
                `;
                section.innerHTML = '<h2 class="section-title">Follow Requests</h2>' + emptyState;
              } else {
                // Update pending count
                const pendingIndicator = document.querySelector('.pending-indicator');
                if (pendingIndicator) {
                  pendingIndicator.textContent = `${remainingRequests.length} pending`;
                }
              }
            }, 300);
          }

          // Show success message
          showNotification(`Follow request ${action}ed successfully!`, 'success');
        } else {
          showNotification(data.message || 'An error occurred', 'error');
        }
      } catch (error) {
        console.error('Error handling follow request:', error);
        showNotification('An error occurred', 'error');
      }
    }

    function showNotification(message, type) {
      // Create and show a temporary notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        transition: all 0.3s ease;
        ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
      `;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>