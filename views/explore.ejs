<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Explore - PostKaro</title>
  <link rel="stylesheet" href="/stylesheets/explore.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Pure Pinterest pins layout for explore */
    body {
      margin: 0;
      padding-top: 80px;
      background: #fafafa;
    }
    
    .pinterest-container {
      column-count: 6;
      column-gap: 16px;
      padding: 16px;
      max-width: 100%;
      margin: 0 auto;
    }
    
    @media (max-width: 1600px) { .pinterest-container { column-count: 5; } }
    @media (max-width: 1200px) { .pinterest-container { column-count: 4; } }
    @media (max-width: 900px) { .pinterest-container { column-count: 3; } }
    @media (max-width: 600px) { .pinterest-container { column-count: 2; } }
    @media (max-width: 400px) { .pinterest-container { column-count: 1; } }
    
    .pin-card {
      break-inside: avoid;
      margin-bottom: 16px;
      border-radius: 16px;
      overflow: hidden;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.2s ease;
      cursor: pointer;
      display: inline-block;
      width: 100%;
    }
    
    .pin-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .pin-media {
      position: relative;
      overflow: hidden;
    }
    
    .pin-card img,
    .pin-card video {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 16px 16px 0 0;
    }
    
    .pin-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(transparent 60%, rgba(0,0,0,0.8));
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 16px;
    }
    
    .pin-card:hover .pin-overlay {
      opacity: 1;
    }
    
    .pin-user {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: auto;
    }
    
    .pin-user a {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: white;
      font-size: 14px;
      font-weight: 500;
    }
    
    .pin-user img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid white;
    }
    
    .pin-actions {
      display: flex;
      gap: 8px;
      align-self: flex-end;
    }
    
    .save-btn,
    .share-btn,
    .more-btn {
      background: white;
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .save-btn {
      background: var(--pinterest-red, #e60023);
      color: white;
    }
    
    .save-btn:hover {
      background: #c7001b;
      transform: scale(1.05);
    }
    
    .share-btn,
    .more-btn {
      background: rgba(255,255,255,0.9);
      color: #333;
    }
    
    .share-btn:hover,
    .more-btn:hover {
      background: white;
      transform: scale(1.05);
    }
    
    .pin-info {
      padding: 16px;
    }
    
    .pin-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .pin-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #666;
    }
    
    .pin-meta img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }
    
    .audio-pin {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      background: linear-gradient(135deg, #f8f8f8, #e8e8e8);
      color: #666;
    }
    
    .audio-pin i {
      font-size: 48px;
      margin-bottom: 12px;
      color: var(--pinterest-red, #e60023);
    }
    
    .voice-note {
      padding: 12px;
      background: #f8f8f8;
      border-top: 1px solid #e8e8e8;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .voice-note i {
      color: var(--pinterest-red, #e60023);
      font-size: 16px;
    }
    
    .voice-note audio {
      flex: 1;
      height: 32px;
    }
    
    .empty-state {
      text-align: center;
      padding: 80px 24px;
      color: #999;
      grid-column: 1 / -1;
    }
    
    .empty-state i {
      font-size: 64px;
      margin-bottom: 24px;
      color: #ddd;
    }
    
    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 16px;
      color: #666;
    }
    
    .fade-in {
      animation: fadeInUp 0.5s ease-out forwards;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Smooth scrolling for the entire page */
    html {
      scroll-behavior: smooth;
    }
    
    /* Enhanced loading states */
    .pin-card.loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* Performance optimizations */
    .pin-card img,
    .pin-card video {
      will-change: transform;
    }
    
    .pin-overlay {
      will-change: opacity;
    }
    
    /* Ensure proper stacking */
    .navbar {
      z-index: 1001;
    }
    
    #loadingSpinner {
      z-index: 1000;
    }
    
    /* Responsive navbar adjustments */
    @media (max-width: 768px) {
      body {
        padding-top: 70px;
      }
      
      .navbar {
        padding: 8px 12px;
      }
      
      .pinterest-container {
        padding: 12px 8px;
        column-gap: 12px;
      }
      
      .pin-card {
        margin-bottom: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Pinterest-style Navbar -->
  <nav class="navbar">
    <div class="navbar-logo">
      <a href="/"><i class="fab fa-pinterest"></i> PostKaro</a>
    </div>
   
    <ul class="navbar-types">
      <li><a href="/">Home</a></li>
      <li><a href="/feed">Your Feed</a></li>
      <li><a href="/explore" class="active">Explore</a></li>
      <li><a href="/dashboard">Your Posts</a></li>
    </ul>

    <div class="navbar-search">
      <input type="text" id="searchInput" placeholder="Search amazing content..." autocomplete="off" />
      <div id="searchResults" class="search-results"></div>
    </div>

    <ul class="navbar-actions">
      <li class="navbar-icon-container">
        <a href="/notifications">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notificationBadge">3+</span>
        </a>
      </li>
      <li class="navbar-icon-container">
        <a href="/profile">
          <i class="fas fa-user"></i>
        </a>
      </li>
      <li class="navbar-icon-container">
        <a href="/logout">
          <i class="fas fa-sign-out-alt"></i>
        </a>
      </li>
      <li class="navbar-icon-container">
        <a href="/conversations">
          <i class="fas fa-envelope"></i>
          <span class="notification-badge message-badge" id="messageBadge">2+</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- Pure Pinterest Masonry Layout - Explore Pins -->
  <% if (posts && posts.length > 0) { %>
    <div class="pinterest-container" id="pinterestContainer">
      <% posts.forEach(function(post) { %>
        <div class="pin-card">
          <div class="pin-media">
            <% if (post.fileType === "image") { %>
              <img src="<%= post.fileUrl %>" alt="<%= post.caption || 'Pin image' %>" loading="lazy">
            <% } else if (post.fileType === "video") { %>
              <video muted autoplay loop playsInline>
                <source src="<%= post.fileUrl %>" type="video/webm">
                Your browser does not support the video tag.
              </video>
            <% } else { %>
              <div class="audio-pin">
                <i class="fas fa-music"></i>
                <p>Audio Pin</p>
              </div>
            <% } %>
            
            <div class="pin-overlay">
              <div class="pin-user">
                <a href="/profile/<%= post.user ? post.user._id : '' %>" class="user-link">
                  <img src="<%= (post.user && post.user.dp) ? post.user.dp : '/images/default-avatar.svg' %>" alt="<%= post.user ? post.user.username : 'User' %>">
                  <span><%= post.user ? post.user.username : 'Unknown' %></span>
                </a>
              </div>
              <div class="pin-actions">
                <form action="/post/<%= post._id %>/save" method="POST" style="display:inline;">
                  <button type="submit" class="save-btn">Save</button>
                </form>
                <button class="share-btn" title="Share"><i class="fas fa-share"></i></button>
                <button class="more-btn" title="More options"><i class="fas fa-ellipsis-h"></i></button>
              </div>
            </div>
          </div>
          
          <div class="pin-info">
            <h3 class="pin-title"><%= post.caption || 'Untitled Pin' %></h3>
            <div class="pin-meta">
              <img src="<%= (post.user && post.user.dp) ? post.user.dp : '/images/default-avatar.svg' %>" alt="<%= post.user ? post.user.username : 'User' %>">
              <span><%= post.user ? post.user.username : 'Unknown' %></span>
              <span>•</span>
              <span><%= Math.floor((Date.now() - new Date(post.createdAt).getTime()) / (1000 * 60 * 60 * 24)) %>d ago</span>
            </div>
            
            <% if (post.description) { %>
              <p style="margin-top: 8px; color: var(--pinterest-grey, #666); font-size: 14px; line-height: 1.4;">
                <%= post.description %>
              </p>
            <% } %>
          </div>
          
          <% if (post.voiceUrl) { %>
            <div class="voice-note">
              <i class="fas fa-microphone"></i>
              <audio controls>
                <source src="<%= post.voiceUrl %>" type="audio/webm">
                Your browser does not support the audio element.
              </audio>
            </div>
          <% } %>
        </div>
      <% }); %>
    </div>
  <% } else { %>
    <div class="empty-state">
      <i class="fas fa-compass"></i>
      <h3>Start exploring amazing content</h3>
      <p>Discover inspiring pins from creators around the world!</p>
    </div>
  <% } %>

  <script>
    // Global variables for infinite scroll
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;

    // Initialize boomerang videos
    function initBoomerangVideos() {
      const videos = document.querySelectorAll('.pin-card video');
      videos.forEach(video => {
        video.muted = true; // Autoplay requires muted videos
        video.loop = false; // We'll handle looping manually for boomerang effect
        video.autoplay = true;
        video.playsInline = true;
        
        // Boomerang effect - play forward then reverse
        video.addEventListener('ended', function() {
          this.currentTime = 0;
          this.play();
        });
        
        // Add hover effect to play/pause
        video.parentElement.addEventListener('mouseenter', () => {
          video.play();
        });
        
        video.parentElement.addEventListener('mouseleave', () => {
          video.pause();
        });
        
        // Intersection Observer for auto-play when in viewport
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              video.play();
            } else {
              video.pause();
            }
          });
        }, { threshold: 0.5 });
        
        observer.observe(video);
      });
    }

    // Create pin card HTML
    function createPinCard(post) {
      const timeAgo = Math.floor((Date.now() - new Date(post.createdAt).getTime()) / (1000 * 60 * 60 * 24));
      const userDp = (post.user && post.user.dp) ? post.user.dp : '/images/default-avatar.svg';
      const username = post.user ? post.user.username : 'Unknown';
      const caption = post.caption || 'Untitled Pin';
      
      let mediaHtml = '';
      if (post.fileType === "image") {
        mediaHtml = `<img src="${post.fileUrl}" alt="${caption}" loading="lazy">`;
      } else if (post.fileType === "video") {
        mediaHtml = `
          <video muted autoplay loop playsInline>
            <source src="${post.fileUrl}" type="video/webm">
            Your browser does not support the video tag.
          </video>`;
      } else {
        mediaHtml = `
          <div class="audio-pin">
            <i class="fas fa-music"></i>
            <p>Audio Pin</p>
          </div>`;
      }
      
      return `
        <div class="pin-card fade-in">
          <div class="pin-media">
            ${mediaHtml}
            <div class="pin-overlay">
              <div class="pin-user">
                <a href="/profile/${post.user ? post.user._id : ''}" class="user-link">
                  <img src="${userDp}" alt="${username}">
                  <span>${username}</span>
                </a>
              </div>
              <div class="pin-actions">
                <form action="/post/${post._id}/save" method="POST" style="display:inline;">
                  <button type="submit" class="save-btn">Save</button>
                </form>
                <button class="share-btn" title="Share"><i class="fas fa-share"></i></button>
                <button class="more-btn" title="More options"><i class="fas fa-ellipsis-h"></i></button>
              </div>
            </div>
          </div>
          <div class="pin-info">
            <h3 class="pin-title">${caption}</h3>
            <div class="pin-meta">
              <img src="${userDp}" alt="${username}">
              <span>${username}</span>
              <span>•</span>
              <span>${timeAgo}d ago</span>
            </div>
            ${post.description ? `<p style="margin-top: 8px; color: #666; font-size: 14px; line-height: 1.4;">${post.description}</p>` : ''}
          </div>
          ${post.voiceUrl ? `
            <div class="voice-note">
              <i class="fas fa-microphone"></i>
              <audio controls>
                <source src="${post.voiceUrl}" type="audio/webm">
                Your browser does not support the audio element.
              </audio>
            </div>
          ` : ''}
        </div>`;
    }

    // Enhanced infinite scroll for explore page - cycles through pins infinitely
    async function loadMorePosts() {
      if (isLoading) return;
      
      isLoading = true;
      showLoadingSpinner();
      
      try {
        const response = await fetch(`/api/explore?page=${currentPage + 1}&limit=24`);
        const data = await response.json();
        
        if (data.posts && data.posts.length > 0) {
          const container = document.getElementById('pinterestContainer');
          const fragment = document.createDocumentFragment();
          
          data.posts.forEach((post, index) => {
            const pinCard = document.createElement('div');
            pinCard.innerHTML = createPinCard(post);
            const cardElement = pinCard.firstElementChild;
            cardElement.style.animationDelay = `${index * 0.05}s`;
            cardElement.classList.add('fade-in');
            fragment.appendChild(cardElement);
          });
          
          container.appendChild(fragment);
          
          // Initialize videos for new posts
          initBoomerangVideos();
          
          currentPage++;
          
          // Preload next batch when we're getting close
          if (data.posts.length >= 20) {
            setTimeout(() => {
              const sentinel = document.getElementById('scrollSentinel');
              const rect = sentinel.getBoundingClientRect();
              if (rect.top < window.innerHeight * 2) {
                loadMorePosts();
              }
            }, 1000);
          }
        } else {
          // No more posts available, cycle back to beginning
          currentPage = 0; // Reset to page 0 so next fetch gets page 1
          // Load from beginning again to maintain infinite scroll
          const firstPageResponse = await fetch(`/api/explore?page=1&limit=24`);
          const firstPageData = await firstPageResponse.json();
          
          if (firstPageData.posts && firstPageData.posts.length > 0) {
            const container = document.getElementById('pinterestContainer');
            const fragment = document.createDocumentFragment();
            
            firstPageData.posts.forEach((post, index) => {
              const pinCard = document.createElement('div');
              pinCard.innerHTML = createPinCard(post);
              const cardElement = pinCard.firstElementChild;
              cardElement.style.animationDelay = `${index * 0.05}s`;
              cardElement.classList.add('fade-in');
              fragment.appendChild(cardElement);
            });
            
            container.appendChild(fragment);
            initBoomerangVideos();
            currentPage = 1; // Next page will be 2
          }
        }
      } catch (error) {
        console.error('Error loading more posts:', error);
      } finally {
        isLoading = false;
        hideLoadingSpinner();
      }
    }

    // Show loading spinner
    function showLoadingSpinner() {
      let spinner = document.getElementById('loadingSpinner');
      if (!spinner) {
        spinner = document.createElement('div');
        spinner.id = 'loadingSpinner';
        spinner.innerHTML = `
          <div style="
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 16px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
          ">
            <div style="
              width: 20px;
              height: 20px;
              border: 2px solid #f3f3f3;
              border-top: 2px solid var(--pinterest-red, #e60023);
              border-radius: 50%;
              animation: spin 1s linear infinite;
            "></div>
            <span style="color: #666; font-size: 14px; font-weight: 500;">Discovering more pins...</span>
          </div>
        `;
        document.body.appendChild(spinner);
      }
      spinner.style.display = 'block';
    }

    // Hide loading spinner
    function hideLoadingSpinner() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.style.display = 'none';
      }
    }
    
    // Show error message
    function showErrorMessage() {
      let errorMessage = document.getElementById('errorMessage');
      if (!errorMessage) {
        errorMessage = document.createElement('div');
        errorMessage.id = 'errorMessage';
        errorMessage.innerHTML = `
          <div style="
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
          ">
            Failed to load pins. Check your connection.
          </div>
        `;
        document.body.appendChild(errorMessage);
        setTimeout(() => {
          errorMessage.remove();
        }, 3000);
      }
    }

    // Enhanced infinite scroll observer - always active
    function initInfiniteScroll() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !isLoading) {
            loadMorePosts();
          }
        });
      }, {
        rootMargin: '300px' // Start loading when 300px from bottom
      });

      // Create sentinel element
      const sentinel = document.createElement('div');
      sentinel.id = 'scrollSentinel';
      sentinel.style.height = '1px';
      sentinel.style.background = 'transparent';
      document.body.appendChild(sentinel);
      
      observer.observe(sentinel);
    }

    // Search functionality
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");

    let searchTimeout;

    searchInput.addEventListener("input", async (e) => {
      const query = e.target.value.trim();
      clearTimeout(searchTimeout);

      if (query.length === 0) {
        searchResults.innerHTML = "";
        searchResults.style.display = "none";
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`/search-users?q=${encodeURIComponent(query)}`);
          const users = await res.json();

          if (users.length === 0) {
            searchResults.innerHTML = "<p class='no-result'>No users found</p>";
          } else {
            searchResults.innerHTML = users.map(user => `
              <div class="search-item" onclick="window.location.href='/profile/${user._id}'">
                <img src="${user.dp || '/images/default-dp.png'}" alt="Profile Picture" />
                <div>
                  <strong>${user.fullname}</strong>
                  <p>@${user.username}</p>
                </div>
              </div>
            `).join("");
          }
          searchResults.style.display = "block";
        } catch (error) {
          console.error("Search error:", error);
          searchResults.innerHTML = "<p class='no-result'>Search error</p>";
          searchResults.style.display = "block";
        }
      }, 300);
    });

    // Hide search results when clicking outside
    document.addEventListener("click", (e) => {
      if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = "none";
      }
    });

    // Share function
    function sharePin(postId) {
      if (navigator.share) {
        navigator.share({
          title: 'Check out this amazing post!',
          url: window.location.origin + '/post/' + postId
        });
      } else {
        // Fallback
        navigator.clipboard.writeText(window.location.origin + '/post/' + postId);
        alert('Link copied to clipboard!');
      }
    }

    // Pin interaction handlers
    document.addEventListener('click', function(e) {
      if (e.target.closest('.share-btn')) {
        e.preventDefault();
        if (navigator.share) {
          navigator.share({
            title: 'Check out this amazing pin!',
            url: window.location.href
          });
        } else {
          navigator.clipboard.writeText(window.location.href);
          alert('Link copied to clipboard!');
        }
      }
    });

    // Notification Counts Function
    async function updateNotificationCounts() {
      try {
        const response = await fetch('/notification-counts');
        const data = await response.json();
        
        const notificationBadge = document.getElementById('notificationBadge');
        const messageBadge = document.getElementById('messageBadge');
        
        if (data.notifications > 0) {
          notificationBadge.textContent = data.notifications > 9 ? '9+' : data.notifications.toString();
          notificationBadge.classList.remove('hidden');
        } else {
          notificationBadge.classList.add('hidden');
        }
        
        if (data.messages > 0) {
          messageBadge.textContent = data.messages > 9 ? '9+' : data.messages.toString();
          messageBadge.classList.remove('hidden');
        } else {
          messageBadge.classList.add('hidden');
        }
        
      } catch (error) {
        console.error('Error fetching notification counts:', error);
      }
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function() {
      updateNotificationCounts();
      initBoomerangVideos();
      initInfiniteScroll();
      
      // Initialize Pinterest layout with animations
      const container = document.getElementById('pinterestContainer');
      if (container) {
        const cards = container.querySelectorAll('.pin-card');
        cards.forEach((card, index) => {
          card.style.animationDelay = `${index * 0.05}s`;
          card.classList.add('fade-in');
        });
      }
      
      // Refresh notification counts every 30 seconds
      setInterval(updateNotificationCounts, 30000);
    });
  </script>
</body>
</html>