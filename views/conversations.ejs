<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chats - Pinterest</title>
  <link rel="stylesheet" href="/stylesheets/chatlist.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --pinterest-red: #e60023;
      --pinterest-black: #111;
      --pinterest-grey: #767676;
      --pinterest-light-grey: #f1f1f1;
      --instagram-blue: #0095f6;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #ffffff;
      color: var(--pinterest-black);
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: white;
      border-bottom: 1px solid #e1e1e1;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--pinterest-black);
      text-decoration: none;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .nav-icon:hover {
      background-color: var(--pinterest-light-grey);
    }

    .nav-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--pinterest-black);
    }

    .nav-actions {
      display: flex;
      gap: 8px;
    }

    .search-container {
      padding: 16px 20px;
      background: white;
      border-bottom: 1px solid #f1f1f1;
    }

    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      color: var(--pinterest-grey);
      z-index: 1;
    }

    #conversationSearch {
      width: 100%;
      padding: 12px 16px 12px 40px;
      border: 1px solid #e1e1e1;
      border-radius: 24px;
      background: var(--pinterest-light-grey);
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }

    #conversationSearch:focus {
      background: white;
      border-color: var(--pinterest-red);
      box-shadow: 0 0 0 2px rgba(230, 0, 35, 0.1);
    }

    .clear-search {
      position: absolute;
      right: 8px;
      background: none;
      border: none;
      padding: 8px;
      border-radius: 50%;
      color: var(--pinterest-grey);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .clear-search:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--pinterest-black);
    }

    .chat-list {
      padding: 0;
      max-width: 600px;
      margin: 0 auto;
    }

    .chat-item.hidden {
      display: none;
    }

    .fab-new-chat {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      background: var(--pinterest-red);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(230, 0, 35, 0.3);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .fab-new-chat:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(230, 0, 35, 0.4);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 70vh;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid #e1e1e1;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--pinterest-black);
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      padding: 8px;
      border-radius: 50%;
      color: var(--pinterest-grey);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .close-modal:hover {
      background: var(--pinterest-light-grey);
      color: var(--pinterest-black);
    }

    .modal-body {
      padding: 20px;
    }

    .user-results {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 16px;
    }

    .user-result-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .user-result-item:hover {
      background: var(--pinterest-light-grey);
    }

    .user-result-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 12px;
      border: 1px solid #e1e1e1;
    }

    .user-result-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-result-info h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--pinterest-black);
      margin: 0 0 2px 0;
    }

    .user-result-info p {
      font-size: 12px;
      color: var(--pinterest-grey);
      margin: 0;
    }

    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: var(--pinterest-grey);
    }

    .no-results i {
      font-size: 32px;
      margin-bottom: 12px;
      color: var(--pinterest-light-grey);
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      text-decoration: none;
      color: inherit;
      border-bottom: 1px solid #f1f1f1;
      transition: background-color 0.2s;
      position: relative;
    }

    .chat-item:hover {
      background-color: #f9f9f9;
    }

    .chat-avatar-container {
      position: relative;
      margin-right: 16px;
    }

    .chat-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid #e1e1e1;
    }

    .chat-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 16px;
      height: 16px;
      background: #42d883;
      border: 3px solid white;
      border-radius: 50%;
    }

    .chat-info {
      flex: 1;
      min-width: 0;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .chat-header h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--pinterest-black);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .chat-time {
      font-size: 12px;
      color: var(--pinterest-grey);
      white-space: nowrap;
    }

    .last-message {
      font-size: 14px;
      color: var(--pinterest-grey);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }

    .unread-message {
      color: var(--pinterest-black);
      font-weight: 500;
    }

    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .unread-indicator {
      background: var(--pinterest-red);
      color: white;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 12px;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }

    .message-preview {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .pending-badge {
      background: var(--instagram-blue);
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 8px;
      white-space: nowrap;
    }

    .no-conversations {
      text-align: center;
      padding: 80px 20px;
      color: var(--pinterest-grey);
    }

    .no-conversations i {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--pinterest-light-grey);
    }

    .no-conversations h3 {
      font-size: 20px;
      margin-bottom: 8px;
      color: var(--pinterest-black);
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(230, 0, 35, 0.4);
      }
      70% {
        box-shadow: 0 0 0 8px rgba(230, 0, 35, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(230, 0, 35, 0);
      }
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .chat-item {
        padding: 12px 16px;
      }
      
      .chat-avatar {
        width: 48px;
        height: 48px;
      }
      
      .chat-avatar-container {
        margin-right: 12px;
      }
      
      .chat-header h4 {
        max-width: 150px;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <a href="/feed" class="nav-icon"><i class="fas fa-arrow-left"></i></a>
    <h2 class="nav-title">Messages</h2>
    <div class="nav-actions">
      <button class="nav-icon" id="markAllRead" title="Mark all as read">
        <i class="fas fa-check-double"></i>
      </button>
      <a href="/profile/<%= currentUser._id %>" class="nav-icon"><i class="fas fa-user"></i></a>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="search-container">
    <div class="search-input-wrapper">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="conversationSearch" placeholder="Search conversations..." autocomplete="off">
      <button class="clear-search" id="clearSearch" style="display: none;"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <!-- Chats List -->
  <div class="chat-list">
    <% if (conversations && conversations.length > 0) { %>
      <% conversations.forEach(conv => { %>
        <a class="chat-item" href="/chat/<%= conv.otherUser._id %>">
          <div class="chat-avatar-container">
            <div class="chat-avatar">
              <img src="<%= conv.otherUser.dp || '/images/default-avatar.svg' %>" 
                   alt="<%= conv.otherUser.fullname %>" 
                   onerror="this.src='/images/default-avatar.svg'">
            </div>
            <!-- Optional: Add online indicator -->
            <!-- <div class="online-indicator"></div> -->
          </div>
          
          <div class="chat-info">
            <div class="chat-header">
              <h4><%= conv.otherUser.fullname || conv.otherUser.username %></h4>
              <span class="chat-time">
                <% if (conv.lastMessage) { %>
                  <% 
                    const now = new Date();
                    const msgTime = new Date(conv.lastMessage.createdAt);
                    const diffHours = Math.floor((now - msgTime) / (1000 * 60 * 60));
                    const diffDays = Math.floor(diffHours / 24);
                  %>
                  <% if (diffDays > 0) { %>
                    <%= diffDays %>d ago
                  <% } else if (diffHours > 0) { %>
                    <%= diffHours %>h ago
                  <% } else { %>
                    <%= msgTime.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) %>
                  <% } %>
                <% } %>
              </span>
            </div>
            
            <div class="message-preview">
              <p class="last-message <%= conv.unreadCount > 0 ? 'unread-message' : '' %>">
                <% if (conv.lastMessage) { %>
                  <% if (conv.lastMessage.text) { %>
                    <%= conv.lastMessage.text.length > 40 ? conv.lastMessage.text.slice(0, 40) + '...' : conv.lastMessage.text %>
                  <% } else { %>
                    <i class="fas fa-image"></i> Media message
                  <% } %>
                <% } else { %>
                  No messages yet
                <% } %>
              </p>
              
              <% if (conv.unreadCount > 0) { %>
                <span class="pending-badge">
                  <%= conv.unreadCount %> new
                </span>
              <% } %>
            </div>
          </div>
          
          <div class="chat-meta">
            <% if (conv.unreadCount > 0) { %>
              <div class="unread-indicator">
                <%= conv.unreadCount > 99 ? '99+' : conv.unreadCount %>
              </div>
            <% } %>
          </div>
        </a>
      <% }) %>
    <% } else { %>
      <div class="no-conversations">
        <i class="fas fa-comments"></i>
        <h3>No conversations yet</h3>
        <p>Start a conversation by visiting someone's profile and sending them a message!</p>
      </div>
    <% } %>
  </div>

  <!-- Floating Action Button for New Chat -->
  <button class="fab-new-chat" id="fabNewChat" title="Start new conversation">
    <i class="fas fa-plus"></i>
  </button>

  <!-- New Chat Modal -->
  <div class="modal-overlay" id="newChatModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Start New Conversation</h3>
        <button class="close-modal" id="closeModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="search-input-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="userSearch" placeholder="Search users..." autocomplete="off">
        </div>
        <div class="user-results" id="userResults">
          <!-- Search results will appear here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Search functionality
    const searchInput = document.getElementById('conversationSearch');
    const clearSearchBtn = document.getElementById('clearSearch');
    const chatItems = document.querySelectorAll('.chat-item');

    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      
      if (searchTerm) {
        clearSearchBtn.style.display = 'block';
      } else {
        clearSearchBtn.style.display = 'none';
      }

      chatItems.forEach(item => {
        const userName = item.querySelector('h4').textContent.toLowerCase();
        const lastMessage = item.querySelector('.last-message').textContent.toLowerCase();
        
        if (userName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });
    });

    clearSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      clearSearchBtn.style.display = 'none';
      chatItems.forEach(item => {
        item.classList.remove('hidden');
      });
      searchInput.focus();
    });

    // Mark all as read functionality
    const markAllReadBtn = document.getElementById('markAllRead');
    
    markAllReadBtn.addEventListener('click', async function() {
      try {
        const response = await fetch('/conversations/mark-all-read', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Remove all unread indicators
          document.querySelectorAll('.unread-indicator, .pending-badge').forEach(el => {
            el.style.display = 'none';
          });
          
          // Remove unread message styling
          document.querySelectorAll('.unread-message').forEach(el => {
            el.classList.remove('unread-message');
          });
          
          // Show success feedback
          markAllReadBtn.style.color = 'green';
          setTimeout(() => {
            markAllReadBtn.style.color = '';
          }, 1000);
        }
      } catch (error) {
        console.error('Error marking all as read:', error);
        // Show error feedback
        markAllReadBtn.style.color = 'red';
        setTimeout(() => {
          markAllReadBtn.style.color = '';
        }, 1000);
      }
    });

    // Add some interactivity
    document.addEventListener('DOMContentLoaded', function() {
      // Add click effects for better user experience
      chatItems.forEach(item => {
        item.addEventListener('click', function(e) {
          // Add a subtle click effect
          this.style.transform = 'scale(0.98)';
          setTimeout(() => {
            this.style.transform = 'scale(1)';
          }, 100);
        });

        // Add long press effect for mobile
        let pressTimer;
        
        item.addEventListener('touchstart', function(e) {
          pressTimer = setTimeout(() => {
            // Show context menu options (future feature)
            console.log('Long press detected');
          }, 800);
        });

        item.addEventListener('touchend', function(e) {
          clearTimeout(pressTimer);
        });

        item.addEventListener('touchmove', function(e) {
          clearTimeout(pressTimer);
        });
      });

      // Auto-refresh unread counts every 30 seconds
      setInterval(function() {
        // Only refresh if page is visible and search is not active
        if (!document.hidden && !searchInput.value.trim()) {
          fetch('/notification-counts')
            .then(response => response.json())
            .then(data => {
              // Update the message count in navigation if needed
              console.log('Updated notification counts:', data);
            })
            .catch(error => console.log('Could not update counts'));
        }
      }, 30000);

      // Add swipe gestures for mobile
      let startX, startY, distX, distY;
      
      chatItems.forEach(item => {
        item.addEventListener('touchstart', function(e) {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        });

        item.addEventListener('touchmove', function(e) {
          if (!startX || !startY) return;
          
          distX = e.touches[0].clientX - startX;
          distY = e.touches[0].clientY - startY;
          
          // Implement swipe actions (future feature)
          if (Math.abs(distX) > Math.abs(distY) && Math.abs(distX) > 50) {
            // Swiped horizontally
            if (distX > 0) {
              // Swiped right - could archive conversation
            } else {
              // Swiped left - could delete conversation
            }
          }
        });

        item.addEventListener('touchend', function() {
          startX = null;
          startY = null;
        });
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + F to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          searchInput.focus();
        }
        
        // Escape to clear search
        if (e.key === 'Escape' && searchInput.value) {
          searchInput.value = '';
          clearSearchBtn.click();
        }
      });

      // New Chat Modal functionality
      const fabNewChat = document.getElementById('fabNewChat');
      const newChatModal = document.getElementById('newChatModal');
      const closeModal = document.getElementById('closeModal');
      const userSearch = document.getElementById('userSearch');
      const userResults = document.getElementById('userResults');

      fabNewChat.addEventListener('click', function() {
        newChatModal.style.display = 'flex';
        setTimeout(() => userSearch.focus(), 100);
      });

      closeModal.addEventListener('click', function() {
        newChatModal.style.display = 'none';
        userSearch.value = '';
        userResults.innerHTML = '';
      });

      newChatModal.addEventListener('click', function(e) {
        if (e.target === newChatModal) {
          closeModal.click();
        }
      });

      // User search functionality
      let searchTimeout;
      userSearch.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (!query) {
          userResults.innerHTML = '';
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const response = await fetch(`/conversations/search-users?q=${encodeURIComponent(query)}`);
            const users = await response.json();
            
            if (users.length === 0) {
              userResults.innerHTML = `
                <div class="no-results">
                  <i class="fas fa-user-slash"></i>
                  <p>No users found</p>
                </div>
              `;
            } else {
              userResults.innerHTML = users.map(user => `
                <div class="user-result-item" onclick="startConversation('${user._id}')">
                  <div class="user-result-avatar">
                    <img src="${user.dp || '/images/default-avatar.png'}" 
                         alt="${user.fullname}"
                         onerror="this.src='/images/default-avatar.png'">
                  </div>
                  <div class="user-result-info">
                    <h4>${user.fullname || user.username}</h4>
                    <p>@${user.username}</p>
                  </div>
                </div>
              `).join('');
            }
          } catch (error) {
            console.error('Error searching users:', error);
            userResults.innerHTML = `
              <div class="no-results">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error searching users</p>
              </div>
            `;
          }
        }, 300);
      });

      // Escape key to close modal
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && newChatModal.style.display === 'flex') {
          closeModal.click();
        }
      });
    });

    // Global function to start conversation
    function startConversation(userId) {
      window.location.href = `/chat/${userId}`;
    }
  </script>

</body>
</html>
